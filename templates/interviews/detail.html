{% extends 'base.html' %}

{% block title %}Interview Detail - AI Case Interview Simulator{% endblock %}

{% block content %}
<div class="h-[calc(100vh-4rem)] flex flex-col">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b px-6 py-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-900">Interview #{{ session.id }}</h1>
            <p class="text-sm text-gray-500">{{ session.get_mode_display }} â€¢ {{ session.get_status_display }}</p>
        </div>
        <div class="flex items-center gap-4">
            <!-- Recording Controls -->
            <div class="flex items-center gap-2">
                <button 
                    id="start-recording-btn" 
                    class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <circle cx="10" cy="10" r="5"/>
                    </svg>
                    Start Recording
                </button>
                <button 
                    id="stop-recording-btn" 
                    class="hidden inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <rect x="6" y="6" width="8" height="8"/>
                    </svg>
                    Stop Recording
                </button>
                <span id="recording-status" class="text-xs text-gray-500 hidden">
                    <span class="inline-block w-2 h-2 bg-red-600 rounded-full animate-pulse mr-1"></span>
                    Recording...
                </span>
            </div>
            <a href="{% url 'interview_list' %}" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">Exit Interview</a>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="flex-1 overflow-y-auto p-6 bg-gray-50" id="chat-log">
        <!-- Messages will be appended here -->
        {% for message in session.messages.all %}
            <div class="flex flex-col mb-4 {% if message.role == 'user' %}items-end{% else %}items-start{% endif %}">
                <div class="max-w-[80%] rounded-lg px-4 py-2 {% if message.role == 'user' %}bg-indigo-600 text-white{% else %}bg-white border border-gray-200 text-gray-800{% endif %} shadow-sm">
                    <p class="text-sm">{{ message.content }}</p>
                </div>
                <span class="text-xs text-gray-400 mt-1">{{ message.timestamp|date:"H:i" }}</span>
            </div>
        {% endfor %}
    </div>

    <!-- Input Area -->
    <div class="bg-white border-t p-4">
        <div class="max-w-4xl mx-auto flex gap-4">
            <textarea 
                id="chat-message-input" 
                rows="1" 
                class="flex-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm resize-none py-3" 
                placeholder="Type your response..."></textarea>
            <button 
                id="chat-message-submit" 
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Send
            </button>
        </div>
    </div>
</div>

<script>
    const sessionId = "{{ session.id }}";
    const chatSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://') +
        window.location.host +
        '/ws/interview/' + sessionId + '/'
    );

    const chatLog = document.querySelector('#chat-log');
    const messageInput = document.querySelector('#chat-message-input');
    const submitButton = document.querySelector('#chat-message-submit');
    
    // Recording variables
    let mediaRecorder = null;
    let recordedChunks = [];
    let stream = null;
    const startRecordingBtn = document.querySelector('#start-recording-btn');
    const stopRecordingBtn = document.querySelector('#stop-recording-btn');
    const recordingStatus = document.querySelector('#recording-status');

    // Scroll to bottom on load
    chatLog.scrollTop = chatLog.scrollHeight;

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;
        const role = data.role || 'user'; // Default to user if not specified

        const wrapper = document.createElement('div');
        wrapper.className = `flex flex-col mb-4 ${role === 'user' ? 'items-end' : 'items-start'}`;
        
        const bubble = document.createElement('div');
        bubble.className = `max-w-[80%] rounded-lg px-4 py-2 ${role === 'user' ? 'bg-indigo-600 text-white' : 'bg-white border border-gray-200 text-gray-800'} shadow-sm`;
        
        const text = document.createElement('p');
        text.className = 'text-sm';
        text.textContent = message;
        
        bubble.appendChild(text);
        wrapper.appendChild(bubble);
        
        // Optional: Add timestamp if available
        
        chatLog.appendChild(wrapper);
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    messageInput.focus();
    messageInput.onkeyup = function(e) {
        if (e.keyCode === 13 && !e.shiftKey) {  // Enter key
            submitButton.click();
        }
    };

    submitButton.onclick = function(e) {
        const message = messageInput.value;
        if (message.trim()) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInput.value = '';
        }
    };
    
    // Recording functionality
    async function startRecording() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: true, 
                audio: true 
            });
            
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm;codecs=vp8,opus'
            });
            
            recordedChunks = [];
            
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = function() {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                uploadRecording(blob);
                
                // Stop all tracks
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            };
            
            mediaRecorder.start();
            
            // Update UI
            startRecordingBtn.classList.add('hidden');
            stopRecordingBtn.classList.remove('hidden');
            recordingStatus.classList.remove('hidden');
            
        } catch (error) {
            console.error('Error accessing media devices:', error);
            alert('Unable to access camera/microphone. Please check permissions.');
        }
    }
    
    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            
            // Update UI
            startRecordingBtn.classList.remove('hidden');
            stopRecordingBtn.classList.add('hidden');
            recordingStatus.classList.add('hidden');
        }
    }
    
    async function uploadRecording(blob) {
        const formData = new FormData();
        formData.append('recording', blob, `recording_${sessionId}_${Date.now()}.webm`);
        formData.append('session_id', sessionId);
        
        try {
            const response = await fetch(`/interviews/${sessionId}/upload-recording/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('Recording uploaded successfully:', data);
                alert('Recording uploaded successfully! Transcription will be processed shortly.');
            } else {
                console.error('Error uploading recording:', response.statusText);
                alert('Error uploading recording. Please try again.');
            }
        } catch (error) {
            console.error('Error uploading recording:', error);
            alert('Error uploading recording. Please try again.');
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Event listeners
    startRecordingBtn.addEventListener('click', startRecording);
    stopRecordingBtn.addEventListener('click', stopRecording);
</script>
{% endblock %}

